<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Visualization | Analyzing and visualizing fiber photometry data with fluoR</title>
  <meta name="description" content="This is meant to explain the reasoning behind fluoR’s functions and how to use them." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Visualization | Analyzing and visualizing fiber photometry data with fluoR" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is meant to explain the reasoning behind fluoR’s functions and how to use them." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Visualization | Analyzing and visualizing fiber photometry data with fluoR" />
  
  <meta name="twitter:description" content="This is meant to explain the reasoning behind fluoR’s functions and how to use them." />
  

<meta name="author" content="Andrew Tamalunas" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="stand.html"/>
<link rel="next" href="analysis.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Analyzing and visualizing fiber photometry data with fluoR</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#index-whyfluor"><i class="fa fa-check"></i><b>1.1</b> Why use fluoR?</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#index-whofluorfor"><i class="fa fa-check"></i><b>1.2</b> Who is fluoR for?</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#background"><i class="fa fa-check"></i><b>1.3</b> Background</a><ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#index-prerecording"><i class="fa fa-check"></i><b>1.3.1</b> pre-recording</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#index-recording"><i class="fa fa-check"></i><b>1.3.2</b> recording</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#index-postrecording"><i class="fa fa-check"></i><b>1.3.3</b> post-recording</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Setting up fluoR</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#intro-install"><i class="fa fa-check"></i><b>2.1</b> Installation</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#intro-convert"><i class="fa fa-check"></i><b>2.2</b> Convert to fluoR format</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#intro-inout"><i class="fa fa-check"></i><b>2.3</b> Input/Output</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#intro-examples"><i class="fa fa-check"></i><b>2.4</b> Examples</a><ul>
<li class="chapter" data-level="2.4.1" data-path="intro.html"><a href="intro.html#intro-formatdata"><i class="fa fa-check"></i><b>2.4.1</b> Format data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="stand.html"><a href="stand.html"><i class="fa fa-check"></i><b>3</b> Standardizing Data</a><ul>
<li class="chapter" data-level="3.1" data-path="stand.html"><a href="stand.html#stand-reasons"><i class="fa fa-check"></i><b>3.1</b> Reasons to standardize data</a></li>
<li class="chapter" data-level="3.2" data-path="stand.html"><a href="stand.html#stand-methods"><i class="fa fa-check"></i><b>3.2</b> Methods of standardization</a><ul>
<li class="chapter" data-level="3.2.1" data-path="stand.html"><a href="stand.html#stand-methods-zscore"><i class="fa fa-check"></i><b>3.2.1</b> z-scores</a></li>
<li class="chapter" data-level="3.2.2" data-path="stand.html"><a href="stand.html#stand-methods-bzscore"><i class="fa fa-check"></i><b>3.2.2</b> baseline z-scores</a></li>
<li class="chapter" data-level="3.2.3" data-path="stand.html"><a href="stand.html#stand-methods-mzscore"><i class="fa fa-check"></i><b>3.2.3</b> modified z scores</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="stand.html"><a href="stand.html#stand-comparison"><i class="fa fa-check"></i><b>3.3</b> z-score comparison</a><ul>
<li class="chapter" data-level="3.3.1" data-path="stand.html"><a href="stand.html#stand-comparison-vis"><i class="fa fa-check"></i><b>3.3.1</b> Visualization</a></li>
<li class="chapter" data-level="3.3.2" data-path="stand.html"><a href="stand.html#stand-comparison-table"><i class="fa fa-check"></i><b>3.3.2</b> Summary table</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="stand.html"><a href="stand.html#stand-examples"><i class="fa fa-check"></i><b>3.4</b> Examples</a><ul>
<li class="chapter" data-level="3.4.1" data-path="stand.html"><a href="stand.html#stand-examples-ex1"><i class="fa fa-check"></i><b>3.4.1</b> Example 1</a></li>
<li class="chapter" data-level="3.4.2" data-path="stand.html"><a href="stand.html#stand-examples-ex2"><i class="fa fa-check"></i><b>3.4.2</b> Example 2</a></li>
<li class="chapter" data-level="3.4.3" data-path="stand.html"><a href="stand.html#stand-examples-ex3"><i class="fa fa-check"></i><b>3.4.3</b> Example 3</a></li>
<li class="chapter" data-level="3.4.4" data-path="stand.html"><a href="stand.html#stand-examples-ex4"><i class="fa fa-check"></i><b>3.4.4</b> Example 4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="vis.html"><a href="vis.html"><i class="fa fa-check"></i><b>4</b> Visualization</a><ul>
<li class="chapter" data-level="4.1" data-path="vis.html"><a href="vis.html#vis-multiple"><i class="fa fa-check"></i><b>4.1</b> Multiple trials</a><ul>
<li class="chapter" data-level="4.1.1" data-path="vis.html"><a href="vis.html#vis-multiple-plotfluor"><i class="fa fa-check"></i><b>4.1.1</b> plot_trials</a></li>
<li class="chapter" data-level="4.1.2" data-path="vis.html"><a href="vis.html#vis-multiple-plotgg"><i class="fa fa-check"></i><b>4.1.2</b> ggplot2</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="vis.html"><a href="vis.html#vis-ranges"><i class="fa fa-check"></i><b>4.2</b> Trial ranges</a></li>
<li class="chapter" data-level="4.3" data-path="vis.html"><a href="vis.html#vis-smoothing"><i class="fa fa-check"></i><b>4.3</b> Smoothing</a><ul>
<li class="chapter" data-level="4.3.1" data-path="vis.html"><a href="vis.html#vis-smoothing-whittaker"><i class="fa fa-check"></i><b>4.3.1</b> Whittaker filter</a></li>
<li class="chapter" data-level="4.3.2" data-path="vis.html"><a href="vis.html#vis-smoothing-gam"><i class="fa fa-check"></i><b>4.3.2</b> Generalized additive modeling</a></li>
<li class="chapter" data-level="4.3.3" data-path="vis.html"><a href="vis.html#vis-smoothing-loess"><i class="fa fa-check"></i><b>4.3.3</b> Loess</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="vis.html"><a href="vis.html#vis-furtherreading"><i class="fa fa-check"></i><b>4.4</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="analysis.html"><a href="analysis.html"><i class="fa fa-check"></i><b>5</b> Analysis</a><ul>
<li class="chapter" data-level="5.1" data-path="analysis.html"><a href="analysis.html#analysis-metrics"><i class="fa fa-check"></i><b>5.1</b> Metrics</a><ul>
<li class="chapter" data-level="5.1.1" data-path="analysis.html"><a href="analysis.html#analysis-metrics-peaks"><i class="fa fa-check"></i><b>5.1.1</b> Peaks</a></li>
<li class="chapter" data-level="5.1.2" data-path="analysis.html"><a href="analysis.html#analysis-metrics-auc"><i class="fa fa-check"></i><b>5.1.2</b> Area under curve</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="analysis.html"><a href="analysis.html#analysis-app"><i class="fa fa-check"></i><b>5.2</b> Applications</a><ul>
<li class="chapter" data-level="5.2.1" data-path="analysis.html"><a href="analysis.html#analysis-app-numpeaks"><i class="fa fa-check"></i><b>5.2.1</b> Number of peaks above z score</a></li>
<li class="chapter" data-level="5.2.2" data-path="analysis.html"><a href="analysis.html#analysis-app-peakdist"><i class="fa fa-check"></i><b>5.2.2</b> Distance between peaks</a></li>
<li class="chapter" data-level="5.2.3" data-path="analysis.html"><a href="analysis.html#analysis-app-auc"><i class="fa fa-check"></i><b>5.2.3</b> Area under curve</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Analyzing and visualizing fiber photometry data with fluoR</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="vis" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Visualization</h1>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="vis.html#cb18-1"></a><span class="kw">library</span>(fluoR)</span>
<span id="cb18-2"><a href="vis.html#cb18-2"></a>df &lt;-<span class="st"> </span><span class="kw">format_data</span>(GCaMP)</span></code></pre></div>
<div id="vis-multiple" class="section level2">
<h2><span class="header-section-number">4.1</span> Multiple trials</h2>
<p>The <code>plot_trials</code> command uses R’s base plotting functions for data exploration purposes. Some benefits of using this function are:</p>
<ol style="list-style-type: decimal">
<li>Much faster graphing than alternatives (e.g. ggplot2, plotly)</li>
<li>Automatic scaling of x- and y- axes for graphing multiple trials so that all data points fit in the plot boundaries</li>
<li>Automatic color coding and trial number labeling</li>
<li>Plotting multiple trials with a single command while using default fluoR data frame format</li>
</ol>
<p>The more you need to graph your data in R, the more clear the tradeoff between <code>plot_trials</code> and <code>ggplot</code> becomes.</p>
<ul>
<li><code>plot_trials</code> will save significant time from extra data manipulation when looking through your data, especially when examining a large number of trials</li>
<li><code>ggplot</code> will be much more appropriate for publication and presentation graphing</li>
</ul>
<div id="vis-multiple-plotfluor" class="section level3">
<h3><span class="header-section-number">4.1.1</span> plot_trials</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="vis.html#cb19-1"></a>base.trials &lt;-<span class="st"> </span><span class="kw">plot_trials</span>(<span class="dt">dataframe =</span> df,</span>
<span id="cb19-2"><a href="vis.html#cb19-2"></a>                           <span class="dt">trials =</span> <span class="dv">8</span><span class="op">:</span><span class="dv">10</span>)</span></code></pre></div>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
</div>
<div id="vis-multiple-plotgg" class="section level3">
<h3><span class="header-section-number">4.1.2</span> ggplot2</h3>
<p>For plotting multiple trials using ggplot2, we will need the data frame to be in “long” format. So, we stack the trials we want to plot.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="vis.html#cb20-1"></a>df.long &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb20-2"><a href="vis.html#cb20-2"></a>  <span class="dt">Time =</span> <span class="kw">rep</span>(df<span class="op">$</span>Time, <span class="dt">times =</span> <span class="dv">3</span>), <span class="co"># repeat time values by number of trials</span></span>
<span id="cb20-3"><a href="vis.html#cb20-3"></a>  <span class="dt">Values =</span> <span class="kw">c</span>(df<span class="op">$</span>Trial8, df<span class="op">$</span>Trial9, df<span class="op">$</span>Trial10), <span class="co"># vector of trial values</span></span>
<span id="cb20-4"><a href="vis.html#cb20-4"></a>  <span class="dt">Trial =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;8&quot;</span>, <span class="kw">length</span>(df<span class="op">$</span>Trial8)), <span class="co"># label trial numbers</span></span>
<span id="cb20-5"><a href="vis.html#cb20-5"></a>            <span class="kw">rep</span>(<span class="st">&quot;9&quot;</span>, <span class="kw">length</span>(df<span class="op">$</span>Trial9)), </span>
<span id="cb20-6"><a href="vis.html#cb20-6"></a>            <span class="kw">rep</span>(<span class="st">&quot;10&quot;</span>, <span class="kw">length</span>(df<span class="op">$</span>Trial10)))</span>
<span id="cb20-7"><a href="vis.html#cb20-7"></a>)</span></code></pre></div>
<p>Now we can make the graph using ggplot2.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="vis.html#cb21-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb21-2"><a href="vis.html#cb21-2"></a><span class="kw">library</span>(ggpubr) <span class="co"># for theme</span></span>
<span id="cb21-3"><a href="vis.html#cb21-3"></a></span>
<span id="cb21-4"><a href="vis.html#cb21-4"></a><span class="kw">ggplot</span>(df.long) <span class="op">+</span></span>
<span id="cb21-5"><a href="vis.html#cb21-5"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Time, <span class="dt">y =</span> Values,</span>
<span id="cb21-6"><a href="vis.html#cb21-6"></a>                <span class="dt">color =</span> Trial)) <span class="op">+</span></span>
<span id="cb21-7"><a href="vis.html#cb21-7"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;8&quot;</span> =<span class="st"> &#39;chartreuse3&#39;</span>, </span>
<span id="cb21-8"><a href="vis.html#cb21-8"></a>                                <span class="st">&quot;9&quot;</span> =<span class="st"> &#39;cornflowerblue&#39;</span>, </span>
<span id="cb21-9"><a href="vis.html#cb21-9"></a>                                <span class="st">&quot;10&quot;</span> =<span class="st"> &#39;darkgoldenrod1&#39;</span>)) <span class="op">+</span></span>
<span id="cb21-10"><a href="vis.html#cb21-10"></a><span class="st">  </span><span class="kw">theme_pubclean</span>()</span></code></pre></div>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
</div>
</div>
<div id="vis-ranges" class="section level2">
<h2><span class="header-section-number">4.2</span> Trial ranges</h2>
<p>Let’s say that you have 30 trials. As part of your hypothesis, you believe that neural activity will change shortly after exposure to a stimulus during trials 1-10, but not subsequent ones.</p>
<p>One method of examining this could be:</p>
<ol style="list-style-type: decimal">
<li>Standardize your data so it accounts for within-subject and between-trial differences</li>
<li>Break your data into “blocks” of 10 and collapse the data across trials for each time point using a summary statistic such as the mean or median</li>
<li>Plot the values using 3 groups: trials 1-10, trials 11-20, and trials 21-30</li>
</ol>
<p>Unfortunately, a 30+ trial dataset would not be ideal to include in the fluoR package. So, we will use trial “blocks” of 3, which results in the groups being trials 1-3, 4-6, and 7-9.</p>
<p>For the first part, we standardize the data into z-scores from baseline.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="vis.html#cb22-1"></a><span class="co">### 1. Standardize data</span></span>
<span id="cb22-2"><a href="vis.html#cb22-2"></a>df.stand &lt;-<span class="st"> </span><span class="kw">baseline_transform</span>(<span class="dt">dataframe =</span> df, </span>
<span id="cb22-3"><a href="vis.html#cb22-3"></a>                               <span class="dt">trials =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, </span>
<span id="cb22-4"><a href="vis.html#cb22-4"></a>                               <span class="dt">baseline.times =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">4</span>,<span class="dv">0</span>),</span>
<span id="cb22-5"><a href="vis.html#cb22-5"></a>                               <span class="dt">type =</span> <span class="st">&#39;z_standard&#39;</span>)</span></code></pre></div>
<p>For the second part, we find the median value for each time point from each of the 3 trial blocks.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="vis.html#cb23-1"></a><span class="co">### 2. Summarize/collapse across blocks of trials</span></span>
<span id="cb23-2"><a href="vis.html#cb23-2"></a>df.block1 &lt;-<span class="st"> </span><span class="kw">summarize_trials</span>(<span class="dt">dataframe =</span> df.stand, <span class="dt">trials =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,</span>
<span id="cb23-3"><a href="vis.html#cb23-3"></a>                              <span class="dt">summary.type =</span> <span class="st">&#39;median&#39;</span>)</span>
<span id="cb23-4"><a href="vis.html#cb23-4"></a>df.block2 &lt;-<span class="st"> </span><span class="kw">summarize_trials</span>(<span class="dt">dataframe =</span> df.stand, <span class="dt">trials =</span> <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>,</span>
<span id="cb23-5"><a href="vis.html#cb23-5"></a>                              <span class="dt">summary.type =</span> <span class="st">&#39;median&#39;</span>)</span>
<span id="cb23-6"><a href="vis.html#cb23-6"></a>df.block3 &lt;-<span class="st"> </span><span class="kw">summarize_trials</span>(<span class="dt">dataframe =</span> df.stand, <span class="dt">trials =</span> <span class="dv">7</span><span class="op">:</span><span class="dv">9</span>,</span>
<span id="cb23-7"><a href="vis.html#cb23-7"></a>                              <span class="dt">summary.type =</span> <span class="st">&#39;median&#39;</span>)</span></code></pre></div>
<p>Graphing summarize data tends to be more for publication than exploration purposes, so we want to use ggplot2. Fortunately, creating multiple data frames <code>summarize_trials</code> allows us to simply assign a label column to each data frame and combine them before graphing.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="vis.html#cb24-1"></a>df.block1<span class="op">$</span>trial.range &lt;-<span class="st"> &#39;1-3&#39;</span></span>
<span id="cb24-2"><a href="vis.html#cb24-2"></a>df.block2<span class="op">$</span>trial.range &lt;-<span class="st"> &#39;4-6&#39;</span></span>
<span id="cb24-3"><a href="vis.html#cb24-3"></a>df.block3<span class="op">$</span>trial.range &lt;-<span class="st"> &#39;7-9&#39;</span></span>
<span id="cb24-4"><a href="vis.html#cb24-4"></a></span>
<span id="cb24-5"><a href="vis.html#cb24-5"></a>df.blocked &lt;-<span class="st"> </span><span class="kw">rbind</span>(df.block1, df.block2, df.block3)</span></code></pre></div>
<p>Last, we plot the summarized values.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="vis.html#cb25-1"></a><span class="kw">ggplot</span>(df.blocked) <span class="op">+</span></span>
<span id="cb25-2"><a href="vis.html#cb25-2"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>,</span>
<span id="cb25-3"><a href="vis.html#cb25-3"></a>             <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">alpha =</span> <span class="fl">0.075</span>) <span class="op">+</span><span class="st"> </span><span class="co"># event onset at 0</span></span>
<span id="cb25-4"><a href="vis.html#cb25-4"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Time, <span class="dt">y =</span> summ.trials,</span>
<span id="cb25-5"><a href="vis.html#cb25-5"></a>                <span class="dt">color =</span> trial.range)) <span class="op">+</span><span class="st"> </span><span class="co"># trial lines</span></span>
<span id="cb25-6"><a href="vis.html#cb25-6"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb25-7"><a href="vis.html#cb25-7"></a>    <span class="dt">x =</span> <span class="st">&#39;Time Post-Onset&#39;</span>,</span>
<span id="cb25-8"><a href="vis.html#cb25-8"></a>    <span class="dt">y =</span> <span class="st">&#39;z score&#39;</span>,</span>
<span id="cb25-9"><a href="vis.html#cb25-9"></a>    <span class="dt">color =</span> <span class="st">&#39;Trials&#39;</span></span>
<span id="cb25-10"><a href="vis.html#cb25-10"></a>  ) <span class="op">+</span></span>
<span id="cb25-11"><a href="vis.html#cb25-11"></a><span class="st">  </span><span class="kw">theme_pubclean</span>()</span></code></pre></div>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
</div>
<div id="vis-smoothing" class="section level2">
<h2><span class="header-section-number">4.3</span> Smoothing</h2>
<p>As you can see by the previous graphs, the recorded data looks sharp when graphed across time points. While this should be used for the data extraction and analysis phase, we do not have this limitation when graphing.</p>
<p>The idea is to keep your data as similar as possible to the original time series while making an appealing visualization. Time series filters can help with this.</p>
<div id="vis-smoothing-whittaker" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Whittaker filter</h3>
<p>The Whittaker filter is a smoother that fits a curve to the data and penalizes highly-deviating points using the penalized least squares (PLS) method. There are two important parameters for this formula:</p>
<ul>
<li><i>lambda</i> - smoothing parameter that controls the amount of curvature allowed for the least-squares fit. A smaller lambda permits more curvature</li>
<li><i>d</i> - order of differences for the least-squares penalty</li>
</ul>
<p>The <code>pracma</code> R package includes an implementation of the Whittaker smoother <span class="citation">(Borchers <a href="#ref-borchers_pracma_2019" role="doc-biblioref">2019</a>)</span>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="vis.html#cb26-1"></a><span class="kw">library</span>(pracma)</span>
<span id="cb26-2"><a href="vis.html#cb26-2"></a></span>
<span id="cb26-3"><a href="vis.html#cb26-3"></a>Trial8.whittaker &lt;-<span class="st"> </span><span class="kw">whittaker</span>(<span class="dt">y =</span> df<span class="op">$</span>Trial8)</span></code></pre></div>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>As shown by the above figure, the Whittaker filter produces a much more “tame” line. In turn, the line makes extreme values (peaks and valleys) smaller. This filter tends to be useful when trying to smooth data without flattening too many curves.</p>
</div>
<div id="vis-smoothing-gam" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Generalized additive modeling</h3>
<p>I have only found generalized additive modeling useful as a smoother or for predictive modeling. This is because GAM’s tend to overfit the model to the data, which is a big no-no in hypothesis testing.</p>
<p>The <code>mgcv</code> R package includes a popular implementation of GAM’s. The formula input for the package’s <code>gam</code> function is styled like R’s base <code>glm</code> function. To smooth our time series data, we use Time as the dependent variable and our observation values as the independent variable.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="vis.html#cb27-1"></a><span class="co">### Compute gam</span></span>
<span id="cb27-2"><a href="vis.html#cb27-2"></a><span class="kw">library</span>(mgcv)</span>
<span id="cb27-3"><a href="vis.html#cb27-3"></a></span>
<span id="cb27-4"><a href="vis.html#cb27-4"></a><span class="co">### Construct model</span></span>
<span id="cb27-5"><a href="vis.html#cb27-5"></a>gam1 &lt;-<span class="st"> </span><span class="kw">gam</span>(Time <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(Trial8, <span class="dt">bs =</span> <span class="st">&#39;cs&#39;</span>), <span class="dt">data =</span> df) <span class="co"># construct model</span></span>
<span id="cb27-6"><a href="vis.html#cb27-6"></a>gamfit &lt;-<span class="st"> </span><span class="kw">predict</span>(gam1, <span class="dt">data =</span> df) <span class="co"># use model to create fitted line</span></span></code></pre></div>
<p>There are also a handful of other parameters found in <a href="https://www.rdocumentation.org/packages/mgcv/versions/1.8-33/topics/gam">the documentation</a> that can be changed, but I typically avoid. If you don’t need to change the additional parameters, <code>ggplot2</code> has a command that smooths the data automatically and scales it to your original data points.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="vis.html#cb28-1"></a><span class="kw">ggplot</span>(df, <span class="kw">aes</span>(<span class="dt">x =</span> Time, <span class="dt">y =</span> Trial8)) <span class="op">+</span></span>
<span id="cb28-2"><a href="vis.html#cb28-2"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb28-3"><a href="vis.html#cb28-3"></a><span class="st">  </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&#39;gam&#39;</span>) <span class="op">+</span></span>
<span id="cb28-4"><a href="vis.html#cb28-4"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb28-5"><a href="vis.html#cb28-5"></a>    <span class="dt">x =</span> <span class="st">&#39;Time Post-Offset&#39;</span>,</span>
<span id="cb28-6"><a href="vis.html#cb28-6"></a>    <span class="dt">y =</span> <span class="st">&#39;Value&#39;</span>,</span>
<span id="cb28-7"><a href="vis.html#cb28-7"></a>    <span class="dt">title =</span> <span class="st">&#39;GAM smoothed line over raw values&#39;</span></span>
<span id="cb28-8"><a href="vis.html#cb28-8"></a>    ) <span class="op">+</span></span>
<span id="cb28-9"><a href="vis.html#cb28-9"></a><span class="st">  </span><span class="kw">theme_pubclean</span>()</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ s(x, bs = &quot;cs&quot;)&#39;</code></pre>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<p>In this situation, the GAM captures the general direction of the data points but almost completely removes smaller peaks/valleys and flattens extreme values.</p>
</div>
<div id="vis-smoothing-loess" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Loess</h3>
<div id="vis-smoothing-loess-model" class="section level4">
<h4><span class="header-section-number">4.3.3.1</span> model</h4>
<p>Locally estimated scatterplot smoothing (loess) is a non-parametric regression that uses multiple regression in k-nearest-neighbor meta-models.</p>
<p>Loess models require much more data than standard regression. Luckily, this makes loess a solid choice for smoothing fiber photometry data. Much less so for testing hypotheses.</p>
<p>The <code>stats</code> package includes the <code>loess</code> function that allows us to implement it in typical R regression form. However, researchers will seldom find use for loess as a model itself.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="vis.html#cb30-1"></a><span class="kw">ggplot</span>(df, <span class="kw">aes</span>(<span class="dt">x =</span> Time, <span class="dt">y =</span> Trial8)) <span class="op">+</span></span>
<span id="cb30-2"><a href="vis.html#cb30-2"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb30-3"><a href="vis.html#cb30-3"></a><span class="st">  </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&#39;loess&#39;</span>) <span class="op">+</span></span>
<span id="cb30-4"><a href="vis.html#cb30-4"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb30-5"><a href="vis.html#cb30-5"></a>    <span class="dt">x =</span> <span class="st">&#39;Time Post-Offset&#39;</span>,</span>
<span id="cb30-6"><a href="vis.html#cb30-6"></a>    <span class="dt">y =</span> <span class="st">&#39;Value&#39;</span>,</span>
<span id="cb30-7"><a href="vis.html#cb30-7"></a>    <span class="dt">title =</span> <span class="st">&#39;Loess smoothed line over raw values&#39;</span></span>
<span id="cb30-8"><a href="vis.html#cb30-8"></a>    ) <span class="op">+</span></span>
<span id="cb30-9"><a href="vis.html#cb30-9"></a><span class="st">  </span><span class="kw">theme_pubclean</span>()</span></code></pre></div>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<p>Additionally, you can change the <code>span</code> parameter to control the degree of smoothing.</p>
<p><img src="fluoR_bookdown_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="vis-furtherreading" class="section level2">
<h2><span class="header-section-number">4.4</span> Further reading</h2>
<p><B><I>Programming</I></B></p>
<ul>
<li>UCLA’s statistics consulting released a guide to working with time series smoothing using the <code>ggplot2</code> package <span class="citation">(Group <a href="#ref-ucla_smoothing" role="doc-biblioref">2016</a>)</span></li>
</ul>
<p><B><I>Math</I></B></p>
<ul>
<li><span class="citation">(Wood, Pya, and Safken <a href="#ref-wood_smoothing_2016" role="doc-biblioref">2016</a>)</span> offer examples of time series smoothing using the <code>mgcv</code> package. The authors also go <i>very</i> in-depth with the math behind the methods.</li>
</ul>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-borchers_pracma_2019">
<p>Borchers, Hans W. 2019. “Pracma: Practical Numerical Math Functions.” <a href="https://CRAN.R-project.org/package=pracma">https://CRAN.R-project.org/package=pracma</a>.</p>
</div>
<div id="ref-ucla_smoothing">
<p>Group, UCLA Statistical Consulting. 2016. “How Can I Explore Different Smooths in Ggplot2? R FAQ.” 2016. <a href="https://stats.idre.ucla.edu/r/faq/how-can-i-explore-different-smooths-in-ggplot2/">https://stats.idre.ucla.edu/r/faq/how-can-i-explore-different-smooths-in-ggplot2/</a>.</p>
</div>
<div id="ref-wood_smoothing_2016">
<p>Wood, Simon N., Natalya Pya, and Benjamin Safken. 2016. “Smoothing Parameter and Model Selection for General Smooth Models.” <em>Journal of the American Statistical Association</em> 111 (516): 1548–63. <a href="https://doi.org/10.1080/01621459.2016.1180986">https://doi.org/10.1080/01621459.2016.1180986</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="stand.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="analysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["fluoR_bookdown.pdf", "fluoR_bookdown.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
